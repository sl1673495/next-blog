<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/ivJUyKh6Uwyov90KnhDy1/pages/368466119.js" as="script"/><link rel="preload" href="/_next/static/ivJUyKh6Uwyov90KnhDy1/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/chunks/42.804f640b9080257d2001.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-c213b3d658f42fde6232.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.59358844195a85e5278d.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-b7de933161803ebe9106.js" as="script"/><link rel="stylesheet" href="/_next/static/css/commons.8b6757c5.chunk.css"/></head><body><div id="__next"><div style="max-width:1000px;margin:auto;padding:20px"><div><h1 class="title"><a href="/">ssh的前端博客</a></h1></div><h1>react-component源码学习（2） rc-steps</h1><div><p>rc-steps是antd的步骤组件所依赖的底层组件，先看官方给的用法示例。</p>
<pre><code class="language-js">&lt;Steps current={1}&gt;
  &lt;Steps.Step title=&quot;first&quot; /&gt;
  &lt;Steps.Step title=&quot;second&quot; /&gt;
  &lt;Steps.Step title=&quot;third&quot; /&gt;
&lt;/Steps&gt;</code></pre>
<p>简洁明了的父子嵌套组件。<br>先从父组件的源码看起。</p>
<h2 id="stepsjsx">Steps.jsx</h2>
<pre><code class="language-js">/* eslint react/no-did-mount-set-state: 0 */
import React, { cloneElement, Children, Component } from &#39;react&#39;;
import PropTypes from &#39;prop-types&#39;;
import { findDOMNode } from &#39;react-dom&#39;;
import classNames from &#39;classnames&#39;;
import debounce from &#39;lodash/debounce&#39;;
import { isFlexSupported } from &#39;./utils&#39;;

export default class Steps extends Component {
  static propTypes = {
    prefixCls: PropTypes.string,
    className: PropTypes.string,
    iconPrefix: PropTypes.string,
    direction: PropTypes.string,
    labelPlacement: PropTypes.string,
    children: PropTypes.any,
    status: PropTypes.string,
    size: PropTypes.string,
    progressDot: PropTypes.oneOfType([
      PropTypes.bool,
      PropTypes.func,
    ]),
    style: PropTypes.object,
    initial: PropTypes.number,
    current: PropTypes.number,
    icons: PropTypes.shape({
      finish: PropTypes.node,
      error: PropTypes.node,
    }),
  };
  static defaultProps = {
    prefixCls: &#39;rc-steps&#39;,
    iconPrefix: &#39;rc&#39;,
    direction: &#39;horizontal&#39;,
    labelPlacement: &#39;horizontal&#39;,
    initial: 0,
    current: 0,
    status: &#39;process&#39;,
    size: &#39;&#39;,
    progressDot: false,
  };
  constructor(props) {
    super(props);
    this.state = {
      flexSupported: true,
      lastStepOffsetWidth: 0,
    };
    this.calcStepOffsetWidth = debounce(this.calcStepOffsetWidth, 150);
  }
  componentDidMount() {
    this.calcStepOffsetWidth();
    if (!isFlexSupported()) {
      this.setState({
        flexSupported: false,
      });
    }
  }
  componentDidUpdate() {
    this.calcStepOffsetWidth();
  }
  componentWillUnmount() {
    if (this.calcTimeout) {
      clearTimeout(this.calcTimeout);
    }
    if (this.calcStepOffsetWidth &amp;&amp; this.calcStepOffsetWidth.cancel) {
      this.calcStepOffsetWidth.cancel();
    }
  }
  calcStepOffsetWidth = () =&gt; {
    if (isFlexSupported()) {
      return;
    }
    // Just for IE9
    const domNode = findDOMNode(this);
    if (domNode.children.length &gt; 0) {
      if (this.calcTimeout) {
        clearTimeout(this.calcTimeout);
      }
      this.calcTimeout = setTimeout(() =&gt; {
        // +1 for fit edge bug of digit width, like 35.4px
        const lastStepOffsetWidth = (domNode.lastChild.offsetWidth || 0) + 1;
        // Reduce shake bug
        if (this.state.lastStepOffsetWidth === lastStepOffsetWidth ||
          Math.abs(this.state.lastStepOffsetWidth - lastStepOffsetWidth) &lt;= 3) {
          return;
        }
        this.setState({ lastStepOffsetWidth });
      });
    }
  }
  render() {
    const {
      prefixCls, style = {}, className, children, direction,
      labelPlacement, iconPrefix, status, size, current, progressDot, initial,
      icons,
      ...restProps,
    } = this.props;
    const { lastStepOffsetWidth, flexSupported } = this.state;
    const filteredChildren = React.Children.toArray(children).filter(c =&gt; !!c);
    const lastIndex = filteredChildren.length - 1;
    const adjustedlabelPlacement = !!progressDot ? &#39;vertical&#39; : labelPlacement;
    const classString = classNames(prefixCls, `${prefixCls}-${direction}`, className, {
      [`${prefixCls}-${size}`]: size,
      [`${prefixCls}-label-${adjustedlabelPlacement}`]: direction === &#39;horizontal&#39;,
      [`${prefixCls}-dot`]: !!progressDot,
    });

    return (
      &lt;div className={classString} style={style} {...restProps}&gt;
        {
          Children.map(filteredChildren, (child, index) =&gt; {
            if (!child) {
              return null;
            }
            const stepNumber = initial + index;
            const childProps = {
              stepNumber: `${stepNumber + 1}`,
              prefixCls,
              iconPrefix,
              wrapperStyle: style,
              progressDot,
              icons,
              ...child.props,
            };
            if (!flexSupported &amp;&amp; direction !== &#39;vertical&#39; &amp;&amp; index !== lastIndex) {
              childProps.itemWidth = `${100 / lastIndex}%`;
              childProps.adjustMarginRight = -Math.round(lastStepOffsetWidth / lastIndex + 1);
            }
            // fix tail color
            if (status === &#39;error&#39; &amp;&amp; index === current - 1) {
              childProps.className = `${prefixCls}-next-error`;
            }
            if (!child.props.status) {
              if (stepNumber === current) {
                childProps.status = status;
              } else if (stepNumber &lt; current) {
                childProps.status = &#39;finish&#39;;
              } else {
                childProps.status = &#39;wait&#39;;
              }
            }
            return cloneElement(child, childProps);
          })
        }
      &lt;/div&gt;
    );
  }
}
</code></pre>
<p>首先看到在componentDidMount, componentDidUpdate阶段都调用了calcStepOffsetWidth这个方法，这个方法其实就是计算lastStepOffsetWidth最后一个步骤条的偏移距离 用来调整子组件的间距到正好撑满容器的效果。</p>
<h3 id="calcstepoffsetwidth">calcStepOffsetWidth</h3>
<p>在这个方法的开头，我们看到</p>
<pre><code class="language-js">if (isFlexSupported()) {
   return;
}</code></pre>
<p>如果浏览器支持flex，就直接return，因为flex本身就是弹性自适应布局，</p>
<pre><code class="language-js">export function isFlexSupported() {
  if (typeof window !== &#39;undefined&#39; &amp;&amp; window.document &amp;&amp; window.document.documentElement) {
    const { documentElement } = window.document;
    return &#39;flex&#39; in documentElement.style ||
      &#39;webkitFlex&#39; in documentElement.style ||
      &#39;Flex&#39; in documentElement.style ||
      &#39;msFlex&#39; in documentElement.style;
  }
  return false;
}</code></pre>
<p>如果不支持flex，<br>则先用React.findDomNode(this)拿到当前组件的dom节点，然后用了一个类似debouce的处理，利用setTimout在下一个事件循环里处理，并且保证一个事件循环里触发的多次此方法被归并成一次，<br>拿到children中lastChild的offsetWidth并且赋给state的lastStepOffsetWidth。</p>
<h3 id="render">render</h3>
<p>filteredChildren是利用React.Children.toArray把子节点转成数组且过滤掉空节点，然后拿到lastIndex最后一项的序号，在最后的return中调用React.Children.map循环子节点数组，在这个循环中，stepNumber是props.initial + index，childProps在child原有的props基础上扩展了<br>stepNumber步骤序号和一系列样式，</p>
<pre><code class="language-js">if (!flexSupported &amp;&amp; direction !== &#39;vertical&#39; &amp;&amp; index !== lastIndex) {
      childProps.itemWidth = `${100 / lastIndex}%`;
      childProps.adjustMarginRight = -Math.round(lastStepOffsetWidth / lastIndex + 1);
}</code></pre>
<p>在不支持flex的情况下继续扩展<br>itemWidth为 100除以最后一项的下标<br>adjustMarginRight 是上面计算的lastStepOffsetWidth除以子元素数量并取负。</p>
<pre><code class="language-js">// fix tail color
   if (status === &#39;error&#39; &amp;&amp; index === current - 1) {
  childProps.className = `${prefixCls}-next-error`;
}</code></pre>
<p>status代表props中传入的当前步骤的状态，如果是错误并且这时候的step是当前步骤的前一个的话，加一个next-error的class</p>
<pre><code class="language-js">          if (!child.props.status) {
              if (stepNumber === current) {
                childProps.status = status;
              } else if (stepNumber &lt; current) {
                childProps.status = &#39;finish&#39;;
              } else {
                childProps.status = &#39;wait&#39;;
              }
            }</code></pre>
<p>这段是假设用户不传入status的情况下自动计算当前应该的状态，<br>current之前是finished 之后是wait</p>
<pre><code class="language-js"> return cloneElement(child, childProps);</code></pre>
<p>最后调用React.cloneElement把child和childProps合并成一个新节点返回。</p>
<h2 id="stepjsx">Step.jsx</h2>
<pre><code class="language-js">import React from &#39;react&#39;;
import PropTypes from &#39;prop-types&#39;;
import classNames from &#39;classnames&#39;;

function isString(str) {
  return typeof str === &#39;string&#39;;
}

export default class Step extends React.Component {
  static propTypes = {
    className: PropTypes.string,
    prefixCls: PropTypes.string,
    style: PropTypes.object,
    wrapperStyle: PropTypes.object,
    itemWidth: PropTypes.oneOfType([
      PropTypes.number,
      PropTypes.string,
    ]),
    status: PropTypes.string,
    iconPrefix: PropTypes.string,
    icon: PropTypes.node,
    adjustMarginRight: PropTypes.oneOfType([
      PropTypes.number,
      PropTypes.string,
    ]),
    stepNumber: PropTypes.string,
    description: PropTypes.any,
    title: PropTypes.any,
    progressDot: PropTypes.oneOfType([
      PropTypes.bool,
      PropTypes.func,
    ]),
    tailContent: PropTypes.any,
    icons: PropTypes.shape({
      finish: PropTypes.node,
      error: PropTypes.node,
    }),
  };
  renderIconNode() {
    const {
      prefixCls, progressDot, stepNumber, status, title, description, icon,
      iconPrefix, icons,
    } = this.props;
    let iconNode;
    const iconClassName = classNames(`${prefixCls}-icon`, `${iconPrefix}icon`, {
      [`${iconPrefix}icon-${icon}`]: icon &amp;&amp; isString(icon),
      [`${iconPrefix}icon-check`]: !icon &amp;&amp; status === &#39;finish&#39; &amp;&amp; (icons &amp;&amp; !icons.finish),
      [`${iconPrefix}icon-close`]: !icon &amp;&amp; status === &#39;error&#39; &amp;&amp; (icons &amp;&amp; !icons.error),
    });
    const iconDot = &lt;span className={`${prefixCls}-icon-dot`}&gt;&lt;/span&gt;;
    // `progressDot` enjoy the highest priority
    if (progressDot) {
      if (typeof progressDot === &#39;function&#39;) {
        iconNode = (
          &lt;span className={`${prefixCls}-icon`}&gt;
            {progressDot(iconDot, { index: stepNumber - 1, status, title, description })}
          &lt;/span&gt;
        );
      } else {
        iconNode = &lt;span className={`${prefixCls}-icon`}&gt;{iconDot}&lt;/span&gt;;
      }
    } else if (icon &amp;&amp; !isString(icon)) {
      iconNode = &lt;span className={`${prefixCls}-icon`}&gt;{icon}&lt;/span&gt;;
    } else if (icons &amp;&amp; icons.finish &amp;&amp; status === &#39;finish&#39;) {
      iconNode = &lt;span className={`${prefixCls}-icon`}&gt;{icons.finish}&lt;/span&gt;;
    } else if (icons &amp;&amp; icons.error &amp;&amp; status === &#39;error&#39;) {
      iconNode = &lt;span className={`${prefixCls}-icon`}&gt;{icons.error}&lt;/span&gt;;
    } else if (icon || status === &#39;finish&#39; || status === &#39;error&#39;) {
      iconNode = &lt;span className={iconClassName} /&gt;;
    } else {
      iconNode = &lt;span className={`${prefixCls}-icon`}&gt;{stepNumber}&lt;/span&gt;;
    }

    return iconNode;
  }
  render() {
    const {
      className, prefixCls, style, itemWidth,
      status = &#39;wait&#39;, iconPrefix, icon, wrapperStyle,
      adjustMarginRight, stepNumber,
      description, title, progressDot, tailContent,
      icons,
      ...restProps,
    } = this.props;

    const classString = classNames(
      `${prefixCls}-item`,
      `${prefixCls}-item-${status}`,
      className,
      { [`${prefixCls}-item-custom`]: icon },
    );
    const stepItemStyle = { ...style };
    if (itemWidth) {
      stepItemStyle.width = itemWidth;
    }
    if (adjustMarginRight) {
      stepItemStyle.marginRight = adjustMarginRight;
    }
    return (
      &lt;div
        {...restProps}
        className={classString}
        style={stepItemStyle}
      &gt;
        &lt;div className={`${prefixCls}-item-tail`}&gt;
          {tailContent}
        &lt;/div&gt;
        &lt;div className={`${prefixCls}-item-icon`}&gt;
          {this.renderIconNode()}
        &lt;/div&gt;
        &lt;div className={`${prefixCls}-item-content`}&gt;
          &lt;div className={`${prefixCls}-item-title`}&gt;
            {title}
          &lt;/div&gt;
          {description &amp;&amp; &lt;div className={`${prefixCls}-item-description`}&gt;{description}&lt;/div&gt;}
        &lt;/div&gt;
      &lt;/div&gt;
    );
  }
}
</code></pre>
<p>子组件里就是根据父组件计算的一些props和本身的props计算出图标和状态进行渲染。</p>
</div></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/368466119","query":{},"buildId":"ivJUyKh6Uwyov90KnhDy1","nextExport":true,"dynamicIds":["+FGM","+fC4","0kiY","1LUk","28xz","2Vkh","3EHr","3gkP","3wag","4Q+X","4qfg","5VxD","5upZ","6ZBy","6k3J","6quq","73oX","75kF","7P7d","7mzT","7oys","8Kqh","8Pgg","8SK+","9Fqr","9G73","9JLW","9Mhc","9Nr/","9Q8I","9U8A","9c9R","9xzc","AIHI","Aayt","Agkw","AhXs","ApBa","Aqyh","AsRY","B05S","BIHe","BKhn","BLBw","BrQc","CyL5","D68y","DxbC","DzyG","E2cJ","EGmf","FIf5","FJ32","G+vv","G01c","GEZ5","GTAt","GgYO","GwJY","Gxxu","H2RM","H4p3","ImXp","JCUK","JGhL","Jb18","Jjkb","JopO","Jrxr","KK3C","KQfT","KUpP","KcjC","Kjk6","KpOm","KyKy","LOdI","LhHj","Ll1m","Lns6","Lo5G","LptB","MF4s","MQ8/","My+Z","NRrW","NyhX","OZ3z","PGlF","PziN","Q5ZB","QPTg","QQjU","QnJG","RLXu","ROUN","Rq6a","SF9x","SLii","Sl5E","T0rU","TdF3","UCcd","UFGb","UI5O","Uasv","VrLj","WSH0","Wj43","WtIr","Xfvt","YROV","YSo5","ZrqW","alHH","beiO","d4EH","ddo8","dnrZ","dycj","e8E9","ebWy","el66","fDA8","fEaW","fHEK","fP8y","fZ2E","gLO8","gmEm","gst6","hmeD","iTGd","ieeH","iobV","irpp","jKVu","jU8F","jW1C","jctj","kZ3Q","lE5/","lKKg","lRCX","lURu","ldBm","m/If","mBTZ","mY11","mzJY","n3/M","nwyE","o0In","oKc0","oU5B","oVRe","oVqn","on2m","ozyK","phP4","pvv5","pw5m","pxCe","qIW7","qUGr","qZUF","r0Rl","r7oX","rfnV","rnof","s8Vx","sM9k","sbla","syIQ","t6qC","tSgA","tluB","u0OR","u2N3","u34i","uIR8","uQpx","uR4j","unZW","vYiF","wB1n","wi1Z","xj1T","yOV0"]}</script><script async="" data-next-page="/368466119" src="/_next/static/ivJUyKh6Uwyov90KnhDy1/pages/368466119.js"></script><script async="" data-next-page="/_app" src="/_next/static/ivJUyKh6Uwyov90KnhDy1/pages/_app.js"></script><script async="" src="/_next/static/chunks/42.804f640b9080257d2001.js"></script><script src="/_next/static/runtime/webpack-c213b3d658f42fde6232.js" async=""></script><script src="/_next/static/chunks/commons.59358844195a85e5278d.js" async=""></script><script src="/_next/static/runtime/main-b7de933161803ebe9106.js" async=""></script></body></html>